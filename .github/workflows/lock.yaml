name: Lock or unlock

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      mode:
        description: Choose "lock" or "unlock"
        required: true
        default: unlock
        type: choice
        options:
          - unlock
          - lock
      reason:
        description: The reason for the "lock." This is not used with the "unlock" mode.
        required: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Determine which mode should perform
        id: meta
        run: |
          echo "mode=${{ inputs.mode || 'lock' }}" >> $GITHUB_OUTPUT
          if [[ '${{ inputs.reason }}' == '' ]]; then
            echo "reason=@${{ github.triggering_actor }} is locking this repository ðŸ”’" >> $GITHUB_OUTPUT
          else
            echo "reason=${{ inputs.reason }}" >> $GITHUB_OUTPUT
          fi
      - name: Lock
        if: steps.meta.outputs.mode == 'lock'
        run: |
          context="[LOCKED] ${{ steps.meta.outputs.reason }}"
          echo "{\"contexts\":[\"$context\"]}" | gh api -X POST repos/${{ github.repository }}/branches/main/protection/required_status_checks/contexts --input -
          echo $context > /tmp/context.txt
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
      - uses: actions/upload-artifact@v3
        if: steps.meta.outputs.mode == 'lock'
        with:
          name: lock
          path: /tmp/context.txt
      - uses: actions/download-artifact@v3
        if: steps.meta.outputs.mode == 'unlock'
        with:
          name: lock
          path: /tmp/context.txt
      - name: Unock
        if: steps.meta.outputs.mode == 'unlock'
        run: echo "{\"contexts\":[\"$(cat /tmp/context.txt)\"]}" | gh api -X DELETE repos/${{ github.repository }}/branches/main/protection/required_status_checks/contexts --input -
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
